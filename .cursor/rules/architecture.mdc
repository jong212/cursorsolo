---
alwaysApply: true
description: Architecture guidelines for the Next.js + Supabase content collection project
---

# ğŸ—ï¸ Architecture Guidelines

## ğŸ“ Project Structure

### Core Architecture
- **Framework**: Next.js 15 with App Router (`app/` directory)
- **Runtime**: React 19 + TypeScript 5
- **Database**: Supabase (PostgreSQL with Edge Functions)
- **Styling**: Tailwind CSS v4 with PostCSS
- **Content**: ë‚˜ëŠ”ì†”ë¡œ ì „ìš© ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œìŠ¤í…œ

### Directory Organization (ë¦¬íŒ©í† ë§ ì™„ë£Œ)
```
my-project/
â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”œâ”€â”€ api/               # API ë¼ìš°íŠ¸ (ê°„ì†Œí™”ë¨)
â”‚   â”‚   â”œâ”€â”€ articles/      # ê¸°ì‚¬ ì¡°íšŒ API
â”‚   â”‚   â”‚   â””â”€â”€ route.ts   # GET ë‚˜ëŠ”ì†”ë¡œ ê¸°ì‚¬ ëª©ë¡
â”‚   â”‚   â””â”€â”€ crawl/manual/  # ìˆ˜ì§‘ ì‹¤í–‰ API
â”‚   â”‚       â””â”€â”€ route.ts   # ë„¤ì´ë²„ ë‰´ìŠ¤ ìˆ˜ì§‘ í”„ë¡ì‹œ
â”‚   â”œâ”€â”€ globals.css        # ê¸€ë¡œë²Œ ìŠ¤íƒ€ì¼ + ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤
â”‚   â”œâ”€â”€ layout.tsx         # ë£¨íŠ¸ ë ˆì´ì•„ì›ƒ
â”‚   â””â”€â”€ page.tsx           # ë‚˜ëŠ”ì†”ë¡œ ë‰´ìŠ¤ ë©”ì¸ í˜ì´ì§€ (ë¦¬íŒ©í† ë§ë¨)
â”œâ”€â”€ supabase/functions/    # Edge Functions
â”‚   â””â”€â”€ crawl_manual/      # ë‚˜ëŠ”ì†”ë¡œ ë‰´ìŠ¤ ìˆ˜ì§‘ í•¨ìˆ˜ (ì™„ì „ ë¦¬íŒ©í† ë§)
â”‚       â””â”€â”€ index.ts       # ë„¤ì´ë²„ ë‰´ìŠ¤ ìŠ¤í¬ë˜í•‘ ë¡œì§
â”œâ”€â”€ .cursor/rules/         # ê°œë°œ ê°€ì´ë“œë¼ì¸
â”‚   â”œâ”€â”€ architecture.mdc   # ì•„í‚¤í…ì²˜ ê°€ì´ë“œ (ì´ íŒŒì¼)
â”‚   â”œâ”€â”€ conventions.mdc    # ì½”ë”© ì»¨ë²¤ì…˜
â”‚   â”œâ”€â”€ styling.mdc        # UI/UX ê°€ì´ë“œ
â”‚   â”œâ”€â”€ data-collection.mdc # ë°ì´í„° ìˆ˜ì§‘ ì›Œí¬í”Œë¡œìš°
â”‚   â””â”€â”€ data-collection-en.mdc # ì˜ë¬¸ ë²ˆì—­ë³¸
â”œâ”€â”€ database-setup.sql     # ë‚˜ëŠ”ì†”ë¡œ ì „ìš© DB ìŠ¤í‚¤ë§ˆ (ì •ë¦¬ë¨)
â””â”€â”€ README.md             # í”„ë¡œì íŠ¸ ê°œìš” (ì—…ë°ì´íŠ¸ë¨)
```

## ğŸ”§ Technical Stack

### Frontend Layer
- **UI Framework**: React 19 with Server Components
- **Routing**: App Router with file-based routing
- **State Management**: React hooks (useState, useEffect)
- **Styling**: Tailwind CSS v4 with CSS variables for theming
- **Fonts**: Geist Sans & Geist Mono via `next/font/google`

### Backend Layer
- **API Routes**: Next.js Route Handlers in `app/api/`
- **Edge Functions**: Supabase Deno runtime for data collection
- **Database**: PostgreSQL with Row Level Security (RLS)
- **Authentication**: Supabase Auth (when needed)

### Data Flow Architecture
```
ë‚˜ëŠ”ì†”ë¡œ ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œìŠ¤í…œ:
User Clicks "Run Collection" â†’ app/page.tsx â†’ /api/crawl/manual â†’ crawl_manual Edge Function â†’ Database
     â†‘                                                                                          â†“
     â””â”€â”€ Auto Refresh Articles â† Collection Results (inserted/skipped/errors) â† RSS Processing â†

Articles Display Flow:
Page Load/Refresh â†’ app/page.tsx â†’ /api/articles â†’ Supabase REST API â†’ articles + sources tables
     â†‘                                                                              â†“
     â””â”€â”€ Display Articles List â† JSON Response (sorted by published_at desc) â†â”€â”€â”€â”€â”˜

Complete Process:
1. User triggers collection via "Run Collection" button
2. Frontend calls Next.js API route (/api/crawl/manual)
3. API route proxies to Supabase Edge Function (crawl_manual)
4. Edge Function fetches enabled sources from database (ë‚˜ëŠ”ì†”ë¡œ ê´€ë ¨ RSS)
5. For each source: fetch RSS â†’ parse â†’ normalize â†’ deduplicate â†’ store
6. Return statistics (inserted, total, skipped, errors)
7. Frontend displays results and auto-refreshes articles
8. Articles API (/api/articles) fetches latest articles sorted by published_at
9. Display articles with thumbnails, titles, summaries, and metadata
```

## ğŸ›¡ï¸ Security Principles

### Environment Variables
- **Client-side**: Only `NEXT_PUBLIC_*` prefixed variables
- **Server-side**: Service role keys NEVER exposed to frontend
- **Production**: Always use server proxy for sensitive operations

### Data Access Patterns
- **Frontend**: Use anon key with RLS policies
- **Server Routes**: Use service role key for admin operations
- **Edge Functions**: Use service role key with proper validation

## ğŸ”„ Development Workflow

### File References (ë¦¬íŒ©í† ë§ í›„)
- Main configuration: [package.json](mdc:package.json)
- TypeScript config: [tsconfig.json](mdc:tsconfig.json)
- Next.js config: [next.config.ts](mdc:next.config.ts)
- Database schema: [database-setup.sql](mdc:database-setup.sql) (ë‚˜ëŠ”ì†”ë¡œ ì „ìš©ìœ¼ë¡œ ì •ë¦¬ë¨)
- Project guide: [README.md](mdc:README.md) (ì™„ì „ ì¬ì‘ì„±ë¨)
- Main UI: [app/page.tsx](mdc:app/page.tsx) (ë‚˜ëŠ”ì†”ë¡œ ë¸Œëœë”© ì ìš©)
- API proxy: [app/api/crawl/manual/route.ts](mdc:app/api/crawl/manual/route.ts) (ê°„ì†Œí™”ë¨)
- Articles API: [app/api/articles/route.ts](mdc:app/api/articles/route.ts) (ìµœì í™”ë¨)
- Edge Function v12: [supabase/functions/crawl_manual/index.ts](mdc:supabase/functions/crawl_manual/index.ts) (ì™„ì „ ë¦¬íŒ©í† ë§)

### ì œê±°ëœ íŒŒì¼ë“¤
- âŒ `doc/devguide.mdc` (README.mdë¡œ í†µí•©)
- âŒ `SETUP.md` (README.mdë¡œ í†µí•©)
- âŒ `app/api/crawl/manual/test-route.ts` (ê°œë°œ ì™„ë£Œë¡œ ë¶ˆí•„ìš”)
- âŒ `deploy-function.sh` (MCP ë„êµ¬ ì‚¬ìš©)
- âŒ `public/file.svg`, `globe.svg`, `vercel.svg`, `window.svg` (ë¯¸ì‚¬ìš© ì•„ì´ì½˜)

### Code Organization
- **Components**: Keep in `app/` directory with co-location
- **Utilities**: Place in `lib/` with clear naming
- **Types**: Define inline or in separate `.d.ts` files
- **API Routes**: Mirror Edge Function structure in `app/api/`

## ğŸš€ Deployment Strategy

### Environment Setup
- **Development**: API proxy to Edge Functions with environment variables
- **Production**: Server proxy pattern with secure environment variables
- **Database**: Use migrations for schema changes via [database-setup.sql](mdc:database-setup.sql)
- **Functions**: Deploy via Supabase CLI or MCP tools
- **MCP Integration**: Supabase MCP server for direct database/function management

### Required Environment Variables
```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...  # Server-side only, never expose to client
```

### Performance Considerations
- **Images**: Use `next/image` for optimization
- **Fonts**: Preload with `next/font` and CSS variables
- **Caching**: Leverage Next.js caching for API routes
- **Database**: Index frequently queried columns (sources.enabled, articles.hash, articles.published_at)

## ğŸ“Š Data Collection System

### Core Functionality
- **Manual Collection**: User-triggered content collection via "Run Collection" button
- **RSS Processing**: Fetch and parse RSS feeds from multiple sources
- **Data Normalization**: Standardize article format (title, summary, URL, author, dates)
- **Deduplication**: SHA-256 hash-based duplicate prevention
- **Error Handling**: Fail-soft approach - one source failure doesn't stop others
- **Statistics Tracking**: Real-time collection metrics (inserted, skipped, errors)

### Database Schema
```sql
-- Sources: External content sources configuration
sources (id, name, type, url, enabled, last_success_at, status_msg)

-- Articles: Collected and normalized content  
articles (id, source_id, title, summary, original_url, canonical_url, 
         thumbnail_url, author, published_at, fetched_at, status, 
         raw_meta, hash, created_at)

-- Key Indexes:
- ux_articles_hash (unique constraint for deduplication)
- idx_sources_enabled (performance for active source queries)
- idx_articles_published (chronological sorting)
```

### Collection Process
1. **Source Management**: Enable/disable sources in database
2. **RSS Fetching**: HTTP requests with proper user agents and headers
3. **Content Parsing**: Regex-based XML parsing (MVP approach)
4. **Data Validation**: Required fields check (title, URL)
5. **Hash Generation**: `canonical_url::title` for deduplication
6. **Database Storage**: Individual inserts with duplicate error handling
7. **Status Updates**: Source success/error status tracking

### Future Enhancements
- **HTML Scraping**: Beyond RSS feeds
- **API Integration**: REST/GraphQL endpoints
- **Cron Scheduling**: Automated collection
- **Content Approval**: Workflow for article review
- **Advanced Parsing**: Dedicated XML/HTML parser libraries